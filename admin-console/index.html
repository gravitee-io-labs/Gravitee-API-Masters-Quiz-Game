<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="/admin/">
    <title>API Masters - Admin Console</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <!-- API Configuration -->
    <script>
        // Set window.API_BASE_URL before loading api.js if needed for production
    </script>
</head>
<body>
    <!-- Login Page -->
    <div id="loginPage" class="login-page active">
        <div class="login-container">
            <div class="logo-container">
                <img src="assets/gravitee-logo/Horizontal_White.svg" alt="Gravitee" class="logo">
            </div>
            <h1>Admin Console</h1>
            <form id="loginForm" class="login-form">
                <div class="form-group">
                    <label for="username">Username</label>
                    <input type="text" id="username" name="username" required autofocus>
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" name="password" required>
                </div>
                <button type="submit" class="btn btn-primary btn-full">Login</button>
                <div id="loginError" class="error-message" style="display: none;"></div>
            </form>
        </div>
    </div>

    <!-- Main Admin Interface -->
    <div id="adminPage" class="admin-page">
        <!-- Header -->
        <header class="admin-header">
            <div class="admin-header-left">
                <img src="assets/gravitee-logo/Horizontal_White.svg" alt="Gravitee" class="header-logo">
                <h1>Quiz Admin Console</h1>
            </div>
            <div class="admin-header-right">
                <div class="control-wrapper">
                    <i class="ph ph-moon"></i>
                    <select id="themeSelect" class="control-select">
                        <option value="system">System</option>
                        <option value="light">Light</option>
                        <option value="dark">Dark</option>
                    </select>
                </div>
                <button id="logoutButton" class="btn btn-secondary">
                    <i class="ph ph-sign-out"></i>
                    Logout
                </button>
            </div>
        </header>

        <!-- Sidebar Navigation -->
        <nav class="sidebar">
            <ul class="nav-menu">
                <li><a href="#questions" class="nav-link active" data-view="questions">
                    <i class="ph ph-question nav-icon"></i>
                    Questions
                </a></li>
                <li><a href="#categories" class="nav-link" data-view="categories">
                    <i class="ph ph-tag nav-icon"></i>
                    Categories
                </a></li>
                <li><a href="#results" class="nav-link" data-view="results">
                    <i class="ph ph-chart-bar nav-icon"></i>
                    Results
                </a></li>
                <li><a href="#settings" class="nav-link" data-view="settings">
                    <i class="ph ph-gear nav-icon"></i>
                    Settings
                </a></li>
            </ul>
        </nav>

        <!-- Main Content Area -->
        <main class="admin-content">
            <!-- Questions View -->
            <div id="questionsView" class="content-view active">
                <div class="view-header">
                    <h2>Questions Management</h2>
                    <button id="addQuestionButton" class="btn btn-primary">
                        <i class="ph ph-plus"></i>
                        Add Question
                    </button>
                </div>
                
                <!-- Search and Filter Bar -->
                <div class="filter-bar">
                    <div class="filter-group">
                        <i class="ph ph-magnifying-glass"></i>
                        <input type="text" id="questionSearchInput" placeholder="Search questions..." class="filter-input">
                    </div>
                    <div class="filter-group">
                        <label for="questionCategoryFilter">Category:</label>
                        <select id="questionCategoryFilter" class="filter-select">
                            <option value="">All</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="questionTypeFilter">Type:</label>
                        <select id="questionTypeFilter" class="filter-select">
                            <option value="">All</option>
                            <option value="text">Text</option>
                            <option value="image">Image</option>
                            <option value="video">Video</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="questionStatusFilter">Status:</label>
                        <select id="questionStatusFilter" class="filter-select">
                            <option value="">All</option>
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>
                    <button id="clearQuestionFiltersButton" class="btn btn-small btn-secondary">
                        <i class="ph ph-x"></i>
                        Clear
                    </button>
                </div>
                
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th class="sortable" onclick="window.adminApp.sortQuestions('id')">ID</th>
                                <th class="sortable" onclick="window.adminApp.sortQuestions('question')">Question (EN)</th>
                                <th class="sortable" onclick="window.adminApp.sortQuestions('category')">Category</th>
                                <th class="sortable" onclick="window.adminApp.sortQuestions('type')">Type</th>
                                <th class="sortable" onclick="window.adminApp.sortQuestions('answer')">Answer</th>
                                <th class="sortable" onclick="window.adminApp.sortQuestions('status')">Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="questionsTableBody">
                            <tr><td colspan="7" class="loading">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Categories View -->
            <div id="categoriesView" class="content-view">
                <div class="view-header">
                    <h2>Categories Management</h2>
                    <button id="addCategoryButton" class="btn btn-primary">
                        <i class="ph ph-plus"></i>
                        Add Category
                    </button>
                </div>
                
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th class="sortable" onclick="window.adminApp.sortCategories('id')">ID</th>
                                <th class="sortable" onclick="window.adminApp.sortCategories('color')">Color</th>
                                <th class="sortable" onclick="window.adminApp.sortCategories('name')">Name</th>
                                <th>Description</th>
                                <th class="sortable" onclick="window.adminApp.sortCategories('questions')">Questions</th>
                                <th class="sortable" onclick="window.adminApp.sortCategories('status')">Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="categoriesTableBody">
                            <tr><td colspan="7" class="loading">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Results View -->
            <div id="resultsView" class="content-view">
                <div class="view-header">
                    <h2>Game Results</h2>
                    <button id="refreshResultsButton" class="btn btn-secondary">
                        <i class="ph ph-arrow-clockwise"></i>
                        Refresh
                    </button>
                </div>
                
                <!-- Search and Filter Bar -->
                <div class="filter-bar">
                    <div class="filter-group">
                        <i class="ph ph-magnifying-glass"></i>
                        <input type="text" id="searchInput" placeholder="Search by name or email..." class="filter-input">
                    </div>
                    <div class="filter-group">
                        <label for="minScore">Min Score:</label>
                        <input type="number" id="minScore" placeholder="0" class="filter-input-small">
                    </div>
                    <div class="filter-group">
                        <label for="maxScore">Max Score:</label>
                        <input type="number" id="maxScore" placeholder="1000" class="filter-input-small">
                    </div>
                    <button id="clearFiltersButton" class="btn btn-small btn-secondary">
                        <i class="ph ph-x"></i>
                        Clear
                    </button>
                </div>
                
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th class="sortable" onclick="window.adminApp.sortResults('id')">ID</th>
                                <th class="sortable" onclick="window.adminApp.sortResults('player')">Player</th>
                                <th>Email</th>
                                <th class="sortable" onclick="window.adminApp.sortResults('score')">Score</th>
                                <th class="sortable" onclick="window.adminApp.sortResults('correct')">Correct</th>
                                <th class="sortable" onclick="window.adminApp.sortResults('wrong')">Wrong</th>
                                <th class="sortable" onclick="window.adminApp.sortResults('date')">Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="resultsTableBody">
                            <tr><td colspan="8" class="loading">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Settings View -->
            <div id="settingsView" class="content-view">
                <div class="view-header">
                    <h2>Game Settings</h2>
                </div>
                <div class="settings-container settings-grid">
                    <div class="settings-form-column">
                        <form id="settingsForm" class="settings-form">
                            <div class="form-group">
                                <label for="questionsPerGame">Questions per Game</label>
                                <input type="number" id="questionsPerGame" name="questions_per_game" min="1" max="50" required>
                                <small>Number of questions in each game session</small>
                            </div>
                            <div class="form-group">
                                <label for="timerSeconds">Timer (seconds)</label>
                                <input type="number" id="timerSeconds" name="timer_seconds" min="5" max="120" required>
                                <small>Time allowed per question</small>
                            </div>
                            <div class="form-group">
                                <label for="pointsCorrect">Points for Correct Answer</label>
                                <input type="number" id="pointsCorrect" name="points_correct" min="0" required>
                                <small>Base points awarded for correct answers</small>
                            </div>
                            <div class="form-group">
                                <label for="pointsWrong">Points for Wrong Answer</label>
                                <input type="number" id="pointsWrong" name="points_wrong" min="0" required>
                                <small>Points awarded for wrong answers (usually 0)</small>
                            </div>
                            <div class="form-group">
                                <label for="timeBonusMax">Maximum Time Bonus</label>
                                <input type="number" id="timeBonusMax" name="time_bonus_max" min="0" required>
                                <small>Maximum bonus points for fast correct answers</small>
                            </div>
                        
                        <div class="category-distribution-section">
                            <h4><i class="ph ph-chart-pie"></i> Category Distribution</h4>
                            <p>Set the percentage of questions from each category in a game. Total must equal 100%.</p>
                            <div id="categoryDistributionContainer" class="category-distribution">
                                <div class="loading">Loading categories...</div>
                            </div>
                            <div class="distribution-total">
                                <span>Total:</span>
                                <strong id="distributionTotal">0%</strong>
                                <span id="distributionStatus" class="distribution-status"></span>
                            </div>
                        </div>
                            
                            <button type="submit" class="btn btn-primary">Save Settings</button>
                        </form>
                    </div>
                    
                    <div class="settings-info-column">
                        <div class="info-box">
                            <h4><i class="ph ph-info"></i> Score Calculation</h4>
                            <p>Each question's score is calculated using the following formula:</p>
                            <div class="formula">
                                <strong>Score = Base Points + Time Bonus</strong>
                            </div>
                            <ul>
                                <li><strong>Correct Answer:</strong> Player receives the base points for correct answers (configured above)</li>
                                <li><strong>Wrong Answer:</strong> Player receives the points for wrong answers (usually 0)</li>
                                <li><strong>Time Bonus:</strong> For correct answers only, players earn bonus points based on speed:
                                    <ul>
                                        <li>Fastest possible answer = Maximum time bonus</li>
                                        <li>Bonus decreases linearly as time increases</li>
                                        <li>No bonus at the time limit</li>
                                        <li>Formula: <code>time_bonus = time_bonus_max × (1 - time_taken / timer_seconds)</code></li>
                                    </ul>
                                </li>
                                <li><strong>Example:</strong> With 1000 base points, 500 max bonus, and 20s timer:
                                    <ul>
                                        <li>Answer in 2s: 1000 + (500 × 0.9) = <strong>1450 points</strong></li>
                                        <li>Answer in 10s: 1000 + (500 × 0.5) = <strong>1250 points</strong></li>
                                        <li>Answer in 20s: 1000 + (500 × 0) = <strong>1000 points</strong></li>
                                    </ul>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Question Modal (Add/Edit) -->
    <div id="questionModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Add Question</h3>
                <button class="modal-close" id="closeModal">&times;</button>
            </div>
            <form id="questionForm" class="modal-form">
                <input type="hidden" id="questionId" name="id">
                
                <!-- Question Text (Full Width) -->
                <div class="form-group">
                    <label for="questionTextEn">Question (English) *</label>
                    <textarea id="questionTextEn" name="question_text_en" rows="3" required></textarea>
                </div>
                
                <div class="form-group">
                    <label for="questionTextFr">Question (French) *</label>
                    <textarea id="questionTextFr" name="question_text_fr" rows="3" required></textarea>
                </div>
                
                <!-- Question Type and Media URL -->
                <div class="form-row form-row-4">
                    <div class="form-group">
                        <label for="questionCategory">Category</label>
                        <select id="questionCategory" name="category_id">
                            <option value="">No Category</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="questionType">Question Type *</label>
                        <select id="questionType" name="question_type" required>
                            <option value="text">Text</option>
                            <option value="image">Image</option>
                            <option value="video">Video</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="correctAnswer">Correct Answer *</label>
                        <select id="correctAnswer" name="correct_answer" required>
                            <option value="green">Green</option>
                            <option value="red">Red</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="difficulty">Difficulty (1-5)</label>
                        <input type="number" id="difficulty" name="difficulty" min="1" max="5" value="1">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="mediaUrl">Media URL (Optional)</label>
                    <input type="url" id="mediaUrl" name="media_url">
                </div>
                
                <!-- Answer Labels -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="greenLabelEn">Green Label (EN)</label>
                        <input type="text" id="greenLabelEn" name="green_label_en" value="Green">
                    </div>
                    <div class="form-group">
                        <label for="greenLabelFr">Green Label (FR)</label>
                        <input type="text" id="greenLabelFr" name="green_label_fr" value="Vert">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="redLabelEn">Red Label (EN)</label>
                        <input type="text" id="redLabelEn" name="red_label_en" value="Red">
                    </div>
                    <div class="form-group">
                        <label for="redLabelFr">Red Label (FR)</label>
                        <input type="text" id="redLabelFr" name="red_label_fr" value="Rouge">
                    </div>
                </div>
                
                <!-- Explanations (Full Width) -->
                <div class="form-group">
                    <label for="explanationEn">Explanation (EN)</label>
                    <textarea id="explanationEn" name="explanation_en" rows="2"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="explanationFr">Explanation (FR)</label>
                    <textarea id="explanationFr" name="explanation_fr" rows="2"></textarea>
                </div>
                
                <!-- Active Checkbox -->
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="isActive" name="is_active" checked>
                        Active
                    </label>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" id="cancelModal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Result Detail Modal -->
    <div id="resultModal" class="modal" style="display: none;">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h3>Game Result Details</h3>
                <button class="modal-close" id="closeResultModal">&times;</button>
            </div>
            <div id="resultDetails" class="result-details"></div>
        </div>
    </div>

    <!-- Category Modal (Add/Edit) -->
    <div id="categoryModal" class="modal" style="display: none;">
        <div class="modal-content modal-small">
            <div class="modal-header">
                <h3 id="categoryModalTitle">Add Category</h3>
                <button class="modal-close" id="closeCategoryModal">&times;</button>
            </div>
            <form id="categoryForm" class="modal-form">
                <input type="hidden" id="categoryId" name="id">
                
                <div class="form-group">
                    <label for="categoryName">Name *</label>
                    <input type="text" id="categoryName" name="name" required maxlength="100">
                </div>
                
                <div class="form-group">
                    <label for="categoryDescription">Description</label>
                    <textarea id="categoryDescription" name="description" rows="3"></textarea>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="categoryColor">Color</label>
                        <div class="color-picker-wrapper">
                            <input type="color" id="categoryColor" name="color" value="#FC5607">
                            <input type="text" id="categoryColorText" value="#FC5607" pattern="^#[0-9A-Fa-f]{6}$">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="categoryIsActive" name="is_active" checked>
                            Active
                        </label>
                    </div>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" id="cancelCategoryModal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="spinner"></div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast" style="display: none;">
        <span id="toastMessage"></span>
    </div>

    <script src="js/theme.js"></script>
    <script src="js/api.js"></script>
    <script src="js/app.js"></script>
</body>
</html>
